@page "/{map?}/{zone?}"
@rendermode InteractiveWebAssembly

@inject HttpClient Http
@inject NavigationManager NavManager
@inject IServiceProvider ServiceProvider
@inject Blazored.LocalStorage.ISyncLocalStorageService LocalStorage

<PageTitle>Trackmania Turbo Records</PageTitle>

@{
    if (MapName is null && MapUid is null && Map is not null)
    {
        if (KnownMaps.ByName.TryGetValue(Map, out var uid))
        {
            MapName = Map;
            MapUid = uid;
        }
        else if (KnownMaps.ByUid.TryGetValue(Map, out var name))
        {
            MapName = name;
            MapUid = Map;
        }
        else
        {
            MapName = null;
            MapUid = Map;
        }
    }

    if (string.IsNullOrWhiteSpace(PlatformQuery))
    {
        Platforms = Platform.PC | Platform.XB1 | Platform.PS4;
    }
    else
    {
        PlatformQueryToPlatforms(PlatformQuery.Split(' ', StringSplitOptions.RemoveEmptyEntries));
    }
}

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudStack>
        <MudText Typo="Typo.h4">Trackmania Turbo Records</MudText>
        <MudText>An open source remake of the <MudLink Href="https://maschell.de/tmt_rankings.php">Maschell TMT rankings</MudLink> site. Type the map number/UID to load the records.</MudText>
        <MudStack Row="true" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
            <MudChipSet @key=chipSetKey SelectedChipsChanged="SelectedPlatformsChangedAsync" Filter="true" MultiSelection="true">
                <MudChip Icon="fas fa-computer" CheckedIcon="fas fa-computer" Text="pc" SelectedColor="Color.Primary" Default="(Platforms & Platform.PC) != 0">&nbsp;&nbsp;PC</MudChip>
                <MudChip Icon="fab fa-xbox" CheckedIcon="fab fa-xbox" SelectedColor="Color.Success" Text="xb1" Default="(Platforms & Platform.XB1) != 0">Xbox One</MudChip>
                <MudChip Icon="fab fa-playstation" CheckedIcon="fab fa-playstation" Text="ps4" SelectedColor="Color.Info" Default="(Platforms & Platform.PS4) != 0">&nbsp;PS4</MudChip>
            </MudChipSet>
            <MudSpacer />
            <Theme></Theme>
            <MudTooltip Text="API">
                <MudIconButton Icon="@Icons.Material.Rounded.Api" Href="/scalar/v1" />
            </MudTooltip>
            <MudTooltip Text="PayPal">
                <MudIconButton Icon="fab fa-paypal" Href="https://www.paypal.me/bigbang1112" />
            </MudTooltip>
            <MudTooltip Text="Docker">
                <MudIconButton Icon="fab fa-docker" Href="https://hub.docker.com/r/bigbang1112/tmturbo-records" />
            </MudTooltip>
            <MudTooltip Text="GitHub">
                <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="https://github.com/BigBang1112/tmturbo-records" />
            </MudTooltip>
        </MudStack>
        <MudStack Row="true" Wrap="Wrap.Wrap">
            <MudAutocomplete ValueChanged="MapNameChangedAsync"
                             Value="MapName"
                             T="string"
                             Label="Map"
                             Variant="Variant.Filled"
                             SearchFunc="SearchMapsAsync"
                             MaxItems="20"></MudAutocomplete>
            <MudTextField ValueChanged="MapUidChangedAsync"
                          Value="MapUid"
                          T="string"
                          Label="UID"
                          Variant="Variant.Filled"></MudTextField>
            <MudAutocomplete ValueChanged="ZoneChangedAsync"
                             Value="Zone"
                             T="string"
                             Label="Zone"
                             Variant="Variant.Filled"
                             Placeholder="World"
                             SearchFunc="SearchZonesAsync"
                             MaxItems="20"></MudAutocomplete>
        </MudStack>
        <MudDivider />
        <MudDataGrid Items="@Records" Filterable="false" Hover="false" Dense="true" Virtualize="true" Breakpoint="Breakpoint.None" Loading="@TableLoading" LoadingProgressColor="Color.Info">
            <Columns>
                <PropertyColumn Property="x => GetRankStr(x)" Title="Rank" />
                <PropertyColumn Property="x => x.Time" Title="Time" />
                <PropertyColumn Property="x => x.Count" Title="Count" />
                <PropertyColumn Property="x => x.Platform" Title="Platforms" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="Record" />
            </PagerContent>
        </MudDataGrid>
    </MudStack>
</MudContainer>
<MudScrollToTop>
    <MudFab Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.ArrowCircleUp" />
</MudScrollToTop>

@code {
    private string chipSetKey = Guid.NewGuid().ToString();

    [Parameter]
    public string? Map { get; set; }

    [Parameter]
    public string? Zone { get; set; }

    [SupplyParameterFromQuery(Name = "p")]
    public string? PlatformQuery { get; set; }

    public Platform Platforms { get; set; } = Platform.PC | Platform.XB1 | Platform.PS4;
    public string? MapName { get; set; }
    public string? MapUid { get; set; }

    public Dictionary<string, Zone>? Zones { get; set; }

    public List<Record> Records { get; set; } = new();

    public bool TableLoading { get; set; }

    public RecordParameters? RequestParameters { get; set; }

    private Dictionary<string, CancellationTokenSource> recordRequestTokenSources = [];

    private System.Text.Json.JsonSerializerOptions jsonOptions = new() { PropertyNameCaseInsensitive = true };

    protected override void OnInitialized()
    {
        jsonOptions.Converters.Add(new JsonTimeInt32Converter());
    }

    private async Task<IEnumerable<string>> SearchZonesAsync(string value)
    {
        Zones ??= await Http.GetFromJsonAsync<Dictionary<string, Zone>>("api/v1/zones") ?? [];

        // if text is null or empty, show complete list
        if (string.IsNullOrEmpty(value))
        {
            return Zones.Select(x => x.Key);
        }

        return Zones.Where(x => x.Key.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Key);
    }

    private Task<IEnumerable<string>> SearchMapsAsync(string value)
    {
        // if text is null or empty, show complete list
        if (string.IsNullOrEmpty(value))
        {
            return Task.FromResult(KnownMaps.ByName.Keys.AsEnumerable());
        }

        return Task.FromResult(KnownMaps.ByName.Keys.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private bool selectedPlatformsReady;
    private async Task SelectedPlatformsChangedAsync(MudChip[] chips)
    {
        var platformQueryLength = string.IsNullOrWhiteSpace(PlatformQuery)
            ? default(int?) : PlatformQuery.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

        if (!selectedPlatformsReady)
        {
            if (chips.Length != (platformQueryLength ?? 3))
            {
                return;
            }

            selectedPlatformsReady = true;
            return;
        }

        PlatformQueryToPlatforms(chips.Select(x => x.Text));
        ChangeNavigation();

        //LocalStorage.SetItem("Platforms", Platforms);

        CheckRecords();
    }

    private void PlatformQueryToPlatforms(IEnumerable<string> platforms)
    {
        Platforms = Platform.None;

        foreach (var platform in platforms)
        {
            Platforms |= platform.ToLowerInvariant() switch
            {
                "pc" => Platform.PC,
                "xb1" => Platform.XB1,
                "ps4" => Platform.PS4,
                _ => Platform.None
            };
        }

        if (Platforms == Platform.None)
        {
            Platforms = Platform.PC | Platform.XB1 | Platform.PS4;
        }
    }

    private async Task MapNameChangedAsync(string? name)
    {
        MapName = name;

        if (name is not null && KnownMaps.ByName.TryGetValue(name, out var uid))
        {
            MapUid = uid;
        }

        CheckRecords();
    }

    private async Task MapUidChangedAsync(string? mapUid)
    {
        MapUid = mapUid;
        MapName = null;

        if (mapUid is not null && KnownMaps.ByUid.TryGetValue(mapUid, out var name))
        {
            MapName = name;
        }

        CheckRecords();
    }

    private async Task ZoneChangedAsync(string zone)
    {
        Zone = zone;
        CheckRecords();
    }

    public void CheckRecords()
    {
        if (string.IsNullOrWhiteSpace(MapUid))
        {
            return;
        }

        var parameters = new RecordParameters(Platforms, MapUid, Zone);

        if (RequestParameters == parameters)
        {
            return;
        }

        RequestParameters = parameters;

        ReloadRecords();
    }

    private Dictionary<Record, int> globalRanks = [];

    private void ReloadRecords()
    {
        Records.Clear();
        globalRanks.Clear();

        var comparer = new RecordComparer();

        foreach (var platform in Platforms.ToString().Split(", ", StringSplitOptions.RemoveEmptyEntries))
        {
            if (Cache.CachedRecords.TryGetValue(GetCachedRecordsKey(platform), out CachedRecords? cachedRecords))
            {
                Records.AddRange(cachedRecords.Records);
                Records.Sort(comparer);

                for (var i = 0; i < Records.Count; i++)
                {
                    globalRanks[Records[i]] = i + 1;
                }

                if (DateTimeOffset.Now - cachedRecords.RequestedAt < TimeSpan.FromMinutes(5))
                {
                    continue;
                }
            }

            RequestRecords(platform);
        }
    }

    private string GetCachedRecordsKey(string platform) => $"{MapUid}_{platform}_{(string.IsNullOrWhiteSpace(Zone) ? "World" : Zone)}";

    private void RequestRecords(string platform)
    {
        TableLoading = true;

        if (recordRequestTokenSources.TryGetValue(platform, out var tokenSource))
        {
            tokenSource.Cancel();
        }

        recordRequestTokenSources[platform] = new CancellationTokenSource();
        Task.Run(async () =>
        {
            using var response = await Http.GetAsync("api/v1/records/" + platform + "/" + MapUid + (string.IsNullOrWhiteSpace(Zone) ? "" : ("/" + Zone)), recordRequestTokenSources[platform].Token);
            await OnResponseAsync(platform, response);
        }, recordRequestTokenSources[platform].Token);
    }

    protected override async void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            /*if (LocalStorage.ContainKey("Platforms"))
                {
                Platforms = LocalStorage.GetItem<Platform>("Platforms");
                chipSetKey = Guid.NewGuid().ToString();
                StateHasChanged();
            }*/

            if (PlatformQuery is not null)
            {
                PlatformQueryToPlatforms(PlatformQuery.Split(' ', StringSplitOptions.RemoveEmptyEntries));
                StateHasChanged();
            }

            if (Map is not null || Zone is not null)
            {
                CheckRecords();
                StateHasChanged();
            }
        }
    }

    private async Task OnResponseAsync(string platform, HttpResponseMessage response)
    {
        recordRequestTokenSources.Remove(platform);

        if (response.StatusCode != System.Net.HttpStatusCode.OK)
        {
            ChangeNavigation();
            TableLoading = false;
            StateHasChanged();
            return;
        }

        List<Record> records;

        try
        {
            records = await response.Content.ReadFromJsonAsync<List<Record>>(jsonOptions) ?? [];
        }
        catch (Exception ex)
        {
            ChangeNavigation();
            TableLoading = false;
            StateHasChanged();
            return;
        }

        Cache.CachedRecords[GetCachedRecordsKey(platform)] = new CachedRecords(DateTimeOffset.Now, records);

        if (recordRequestTokenSources.Count == 0)
        {
            ChangeNavigation();

            ReloadRecords();
            TableLoading = false;
        }

        StateHasChanged();
    }

    private void NavigateToWithQueryParam(string? path, string param, string? value)
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (string.IsNullOrEmpty(value))
        {
            query.Remove(param);
        }
        else
        {
            query[param] = value;
        }

        if (query.Count == 0)
        {
            NavManager.NavigateTo(path ?? string.Empty);
            return;
        }

        NavManager.NavigateTo(path + "?" + query.ToString());
    }

    private void ChangeNavigation()
    {
        var platformQuery = Platforms == (Platform.PC | Platform.XB1 | Platform.PS4)
            ? "" : string.Join(' ', Platforms.ToString().Split(", ", StringSplitOptions.RemoveEmptyEntries));

        if (string.IsNullOrWhiteSpace(Zone))
        {
            if (MapName is not null)
            {
                NavigateToWithQueryParam(MapName, "p", platformQuery);
            }
            else
            {
                NavigateToWithQueryParam(MapUid, "p", platformQuery);
            }
        }
        else
        {
            if (MapName is not null)
            {
                NavigateToWithQueryParam($"{MapName}/{Zone}", "p", platformQuery);
            }
            else
            {
                NavigateToWithQueryParam($"{MapUid}/{Zone}", "p", platformQuery);
            }
        }
    }

    private string GetRankStr(Record rec)
    {
        if (globalRanks.TryGetValue(rec, out var rank))
        {
            return $"{rank} ({rec.Rank})";
        }

        return $"- ({rec.Rank})";
    }
}
